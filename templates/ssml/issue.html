{% extends 'ssml/ssmlbase.html' %}
{% load static %}

{% block body %}

<div class="card-header">
    <div class="d-flex justify-content-between">
        <div class="w-50 d-flex">
            <button id="create_issue" class="btn btn-primary ms-2"><i class="bi bi-plus"></i> New</button>
            <button id="previous_issue" class="btn btn-info ms-2"><i class="bi bi-caret-left-fill"></i></button>
            <button id="next_issue" class="btn btn-info ms-2"><i class="bi bi-caret-right-fill"></i></button>
        </div>
        <div class="w-50 d-flex justify-content-end align-items-center">
            <button class="btn btn-success ms-2 btn-sm" id="post_issue">Post</button>
            <button class="btn btn-warning ms-2 btn-sm" id="unpost_issue">Unpost</button>
            <button class="btn btn-info ms-2 btn-sm" id="edit_issue">Edit</button>
            <button class="btn btn-danger ms-2 btn-sm" id="print_issue">Print</button>
            <button class="btn btn-danger ms-2 btn-sm" id="delete_issue">Delete</button>
            <button class="btn btn-secondary ms-2 btn-sm" id="issue_meters">Meters</button>
        </div>
    </div>
</div>

<div class="card-body">
    <div class="container p-1">
        <div class="row bg-warning text-dark py-4">
            <div class="col-md-4">
                <div class="form-group row mb-2">
                    <label for="supplier" class="col-sm-4 col-form-label">Contractor</label>
                    <div class="col-sm-8">
                        <input type="text" placeholder="" disabled class="form-control" id="contractor" name="contractor">
                        <input type="hidden" id="id" name="id">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="issue_no" class="col-sm-4 col-form-label">issue No</label>
                    <div class="col-sm-8">
                        <input type="text" placeholder="auto generate" disabled class="form-control" id="issue_no" name="issue_no">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="issue_date" class="col-sm-4 col-form-label">issue Date</label>
                    <div class="col-sm-8">
                        <input type="date" readonly class="form-control" id="issue_date" name="issue_date">
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="form-group row mb-2">
                    <label for="total_qty" class="col-sm-4 col-form-label">Total Qty</label>
                    <div class="col-sm-8">
                        <input type="text" readonly class="form-control" id="total_qty" name="total_qty">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="total_amount" class="col-sm-4 col-form-label">Total Amount</label>
                    <div class="col-sm-8">
                        <input type="text" readonly class="form-control" id="total_amount" name="total_amount">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="remarks" class="col-sm-4 col-form-label">Remarks</label>
                    <div class="col-sm-8">
                        <input type="text" readonly class="form-control" id="remarks" name="remarks">
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="form-group row mb-2">
                    <label for="issue_type" class="col-sm-4 col-form-label">issue Type</label>
                    <div class="col-sm-8">
                        <input type="text" readonly class="form-control" id="issue_type" name="issue_type">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="issue_status" class="col-sm-4 col-form-label">issue Status</label>
                    <div class="col-sm-8">
                        <input type="text" readonly class="form-control" id="issue_status" name="issue_status">
                    </div>
                </div>
                <div class="form-group row mb-2">
                    <label for="created_by" class="col-sm-4 col-form-label">Created By</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" value="" readonly id="created_by" name="created_by">
                    </div>
                </div>
            </div>
        </div>

        <div class="row my-2">
            <div class="col-md-12" style="background-color: #fff;">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th style="width: 150px;">BARCODE</th>
                                <th style="width: 300px;">NAME</th>
                                <th>UOM</th>
                                <th>PACK QTY</th>
                                <th>QTY</th>
                                <th>UNIT. QTY</th>
                                <th>RATE</th>
                                <th>AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody id="row_list">
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let next_row = "";
    let prev_row = "";

    async function load_issue(id){
        let payload = {
            module:'issue',
            data:{
                id:id
            }
        }

        await api.v2('VIEW',payload,'/ssml/api/').then(response => {
            if(anton.IsRequest(response)){
                let issue = response.message;
                
                next_row = issue.next_row;
                prev_row = issue.prev_row;

                $('#contractor').val(issue.contractor.company);
                $('#id').val(issue.id);
                $('#issue_no').val(issue.issue_no);
                $('#issue_date').val(issue.issue_date);
                $('#total_qty').val(issue.total_qty);
                $('#total_amount').val(issue.total_amount);
                $('#remarks').val(issue.remarks);
                $('#issue_type').val(issue.issue_type);
                $('#issue_status').val(issue.status);
                $('#created_by').val(issue.created_by);
                $('#posted_by').val(issue.posted_by);
                $('#row_list').empty();

                if(issue.status == 'Posted'){
                    $('#post_issue').attr('disabled',true);
                    $('#unpost_issue').attr('disabled',false);
                    $('#edit_issue').attr('disabled',true);
                } else {
                    $('#post_issue').attr('disabled',false);
                    $('#unpost_issue').attr('disabled',true);
                    $('#edit_issue').attr('disabled',false);
                }

                if(issue.next_row == 0){
                    $('#next_issue').attr('disabled',true);
                } else {
                    $('#next_issue').attr('disabled',false);
                }
                if(issue.prev_row == 0){
                    $('#previous_issue').attr('disabled',true);
                } else {
                    $('#previous_issue').attr('disabled',false);
                }
                
                let transactions = issue.transactions;
                let row_list = $('#row_list');
                row_list.empty();
                let line = 1;
                transactions.forEach(transaction => {
                    console.table(transaction);
                    let qty = transaction.qty;
                    let pack_qty = transaction.pack_qty;
                    console.log(qty);
                    row_list.append(`<tr>
                        <td>${line}</td>
                        <td>${transaction.barcode}</td>
                        <td>${transaction.name}</td>
                        <td>${transaction.uom}</td>
                        <td>${transaction.pack_qty}</td>
                        <td>${qty}</td>
                        <td>${transaction.total_qty}</td>
                        <td>${transaction.rate}</td>
                        <td>${transaction.amount}</td>
                    `);
                    line++;
                });
                $('#row_list').append(row_list);
                console.table(issue);
            } else {
                kasa.response(response);
            }
        }).catch(error => {
            kasa.error(error);
        });
        
    }

    $(document).ready(function(){
        load_issue('{{last_issue.pk}}');

        $('#issue_meters').click(async function(){
            let ids = ['id'];
            let payload = {
                module:'issue_meters',
                data:anton.Inputs(ids)
            }
            await api.v2('VIEW',payload,'/ssml/api/').then(response => {
                
                if(anton.IsRequest(response)){
                    let meters = response.message;
                    let tr = '';
                    meters.forEach(meter => {
                        tr += `<tr>
                            <td>${meter.meter_no}</td>
                            <td>${meter.contractor.company}</td>
                            <td>${meter.created_at}</td>
                        </tr>`;
                    });
                    let table = `<table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Meter No</th>
                                <th>Contractor</th>
                                <th>Issued On</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tr}
                        </tbody>
                    </table>`;
                    amodal.setTitleText('Meters');
                    amodal.setBodyHtml(table);
                    amodal.show();
                    console.table(meters);
                } else {
                    kasa.error(response.message);
                }
            }).catch(error => {
                kasa.error(error);
            });
        });

        $('#create_issue').click(function(){
            location.href = '{% url "issue_add" %}';
        });

        $('#previous_issue').click(function(){
            load_issue(prev_row);
        });

        $('#next_issue').click(function(){
            load_issue(next_row);
        });

        $('#edit_issue').click(function(){
            location.href = `/ssml/inventory/issue/edit/${$('#id').val()}/`;
        });

        $('#post_issue').click(async function(){
            if(confirm('Are you sure you want to post this issue?')){
                let ids  = ['id','mypk'];
                let payload = {
                    module:'post_issue',
                    data:anton.Inputs(ids)
                }
                await api.v2('PATCH',payload,'/ssml/api/').then(response => {
                    kasa.response(response);
                    if(anton.IsRequest(response)){
                        kasa.success('Issue posted successfully');
                        load_issue($('#id').val());
                    } else {
                        kasa.error(response.message);
                    }
                }).catch(error => {
                    kasa.error(error);
                });
            } else {
                kasa.info('Operation cancelled');
            }
        });

        $('#unpost_issue').click(async function(){
            if(confirm('Are you sure you want to unpost this issue?')){
                let ids  = ['id','mypk'];
                let payload = {
                    module:'unpost_issue',
                    data:anton.Inputs(ids)
                }
                await api.v2('PATCH',payload,'/ssml/api/').then(response => {
                    kasa.response(response);
                    if(anton.IsRequest(response)){
                        kasa.success('Issue unposted successfully');
                        load_issue($('#id').val());
                    } else {
                        kasa.error(response.message);
                    }
                }).catch(error => {
                    kasa.error(error);
                });
            } else {
                kasa.info('Operation cancelled');
            }
        });

        $('#print_issue').click(async function(){
            let ids  = ['id'];
            let payload = {
                module:'print_issue',
                data:anton.Inputs(ids)
            }
            await api.v2('VIEW',payload,'/ssml/api/').then(response => {
                
                if(anton.IsRequest(response)){
                    let issue = response.message;
                    let url = issue;
                    anton.viewFile(`/${url}`, 'Issue Print');
                    // kasa.success('Issue printed successfully');
                } else {
                    kasa.error(response.message);
                }
            }).catch(error => {
                kasa.error(error);
            });
        });

        $('#delete_issue').click(function(){
            if(confirm('Are you sure you want to delete this issue?')){
                ssml.deleteIssue($('#id').val());
            } else {
                kasa.info('Operation cancelled');
            }
        });
    });
</script>


{% endblock %}