{% extends 'ssml/ssmlbase.html' %}
{% load static %}

{% block body %}
        <div class="card-header">
            <div class="w-100 d-flex flex-wrap">
                <div class="w-50 d-flex flex-wrap align-content-center">
                    <button class="btn btn-warning btn-sm ms-2">CANCEL</button>
                    <button class="btn btn-success btn-sm ms-2" id="save">SAVE</button>
                </div>
                <div class="w-50 d-flex flex-wrap align-content-center justify-content-end">
                    <button class="btn btn-info btn-sm" id="new_line"><i class="fa fa-plus"></i> NEW LINE</button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="container-fluid p-0">
                <div class="row bg-info p-3">
                    <div class="col-sm-3">
                        <div class="row mb-3">
                            <div class="col-sm-4"><label for="entry_no">Enter No.</label></div>
                            <div class="col-sm-8">
                                <input type="text" id="entry_no" class="form-control form-control-sm rounded-0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-4"><label for="entry_date">Enter Date.</label></div>
                            <div class="col-sm-8">
                                <input type="date" id="entry_date" class="form-control form-control-sm rounded-0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><label for="tran_type">Type</label></div>
                            <div class="col-sm-8">

                                <select name="" id="tran_type" class="form-control form-control-sm rounded-0">
                                    <option value="" disabled selected>Select Type</option>
                                    <option value="int">Internal</option>
                                    <option value="ext">External</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-3">
                        <div class="row">
                            <div class="col-sm-4"><label for="loc_from">From Loc.</label></div>
                            <div class="col-sm-8 mb-3">
                                <select name="" id="loc_from" class="form-control form-control-sm rounded-0">
                                    <option value="" disabled selected>Select From</option>
                                    {% for loc in locations %}
                                        <option value="{{ loc.id }}">{{ loc.loc_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-sm-4"><label for="loc_to">From Loc.</label></div>
                            <div class="col-sm-8 mb-3">
                                <select name="" id="loc_to" class="form-control form-control-sm rounded-0">
                                    <option value="" disabled selected>Select From</option>
                                    {% for loc in locations %}
                                        <option value="{{ loc.id }}">{{ loc.loc_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                        <!-- REMARKs -->
                            <div class="col-sm-4"><label for="remarks">Remarks</label></div>
                            <div class="col-sm-8"><input type="text" id="remarks" class="form-control form-control-sm rounded-0"></div>
                        </div>
                    </div>


                    <div class="col-sm-3">
                        <div class="row mb-3">
                            <div class="col-sm-4"><label for="created_by">Created By</label></div>
                            <div class="col-sm-8 mb-3"><input type="text" id="created_by" class="form-control form-control-sm rounded-0"></div>

                            <div class="col-sm-4"><label for="delivered_by">Delivered By</label></div>
                            <div class="col-sm-4"><input type="text" id="delivered_by" class="form-control form-control-sm rounded-0"></div>
                            <div class="col-sm-4 mb-3"><input type="text" id="car_no" class="form-control form-control-sm rounded-0"></div>

                            <div class="col-sm-4"><label for="approved_by">Approved By</label></div>
                            <div class="col-sm-8 mb-3"><input type="text" id="approved_by" class="form-control form-control-sm rounded-0"></div>

                        </div>
                    </div>

                    <div class="col-sm-3">
                        <div class="row">
                            <div class="col-sm-4"><label for="total_qty">Total QTY.</label></div>
                            <div class="col-sm-8 mb-3"><input type="text" id="total_qty" class="form-control form-control-sm rounded-0"></div>

                            <div class="col-sm-4"><label for="total_amt">Total AMT.</label></div>
                            <div class="col-sm-8 mb-3"><input type="text" id="total_amt" class="form-control form-control-sm rounded-0"></div>

                            <div class="col-sm-4"><label for="status">Status</label></div>
                            <div class="col-sm-8 mb-3"><input type="text" id="status" class="form-control form-control-sm rounded-0"></div>


                        </div>
                    </div>

                </div>

                <div class="w-100 overflow-auto bg-dark-light table-responsive" style="height: 60vh!important">
                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>LN</th>
                                <th>BARCODE</th>
                                <th>NAME</th>
                                <th>PACKING</th>
                                <th>PACK QTY</th>
                                <th>SENT QTY</th>
                                <th>REC. QTY</th>
                                <th>TOTAL COST</th>
                            </tr>
                        </thead>
                        <tbody id="tran_table">
                           
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <script>
        $(document).ready(function(){
            $('#save').click(async function(){
                let ids =  ['entry_date','tran_type','loc_from','loc_to','remarks','mypk'];
                if(anton.validateInputs(ids)){
                    let hd = anton.Inputs(ids)
                    // validate transactions
                    let t_l = $('#tran_table tr').length;
                    if(t_l > 0){
                        // Loop through each row in tran_table and check if required fields have values
                        let valid = true;
                        let errorMsg = "";
                        let transactions = []
                        $('#tran_table tr').each(function(index, tr){
                            // Get all td elements in the row
                            let tds = $(tr).find('td');
                            let tr_id = $(tr).attr('id');
                            let sn = '';
                            if (tr_id) {
                                let parts = tr_id.split('_');
                                sn = parts[parts.length - 1];
                            }

                            console.log('LINE NUMBER',sn)
                            let this_ids = [
                                `pack_${sn}`,`pack_qty_${sn}`,`sent_qty_${sn}`,`total_cost_${sn}`
                            ]

                            if(anton.validateInputs(this_ids)){
                                transactions.push({
                                    barcode:$(`#barcode_${sn}`).text(),
                                    pack_qty:$(`#pack_qty_${sn}`).val(),
                                    oum:$(`#pack_${sn}`).val(),
                                    sent_qty:$(`#sent_qty_${sn}`).val()
                                })
                            } else {
                                valid = false;
                                errorMsg = `Row ${index+1} is missing required fields.`;
                                return false; // break out of .each
                            }
                            
                        });



                        if(!valid){
                            kasa.error(errorMsg);
                            return;
                        } else {
                            let payload = {
                                module:'transfer',
                                data:{
                                    transactions:transactions,
                                    header:hd
                                }
                            }
                            console.log('PAYLOAD')
                            console.table(payload)
                            console.log('PAYLOAD END')
                            await api.v2('PUT',payload,'/ssml/api/').then(response => {
                                if(anton.IsRequest(response)){
                                    kasa.confirm(response.message,1,'/ssml/inventory/trenasfer/')
                                } else {
                                    kasa.response(response)
                                }
                            }).catch(error => {kasa.error(error)})
                        }
                    } else {
                        
                        kasa.error("Invalid Transactions")

                    }

                } else {
                    kasa.error("Invalid Header")
                }
            })

            $('#new_line').click(function(){
                let html = `
                    <div class="w-100 table-responsive">
                        <table class='table table-bordered table-hover'>
                            <thead>
                                <tr><td>IMG</td><td>BARCODE</td><td>NAME</td><td>ACTION</td></tr>
                            </thead>
                                        <tbody id='mat_bd'></tbody>
                        </table>

                    </div>
                `;

                amodal.setBodyHtml(html)
                amodal.setTitleHtml(`<input type="search" id="search_prod_string" class="form-control form-control-sm rounded-0" placeholder="name or barcode"> `)
                amodal.show()

                $('#search_prod_string').keypress(async function (e) {
                    if (e.keyCode === 13) {
                        let search_string = $(this).val();
                        if (search_string.length > 0) {
                            // Handle search here
                            if(search_string.length > 0){
                                let payload = {
                                    module:'material',
                                    data:{
                                        find_by:'string',
                                        id:search_string
                                    }
                                }

                                await api.v2('VIEW',payload,'/ssml/api/').then(response => {
                                    if(anton.IsRequest(response)){
                                        let message = response['message'];

                                        let tr = ``
                                        message.map(item =>{
                                            console.table(item)
                                            tr += `<tr>
                                                          <td><img style='width:30px' src="${item['image']}" alt="" class="img-fluie"></td>
                                                          <td>${item['barcode']}</td>
                                                           <td>${item['name']}</td>
                                                            <td><a href="javascript:void(0)" class='add_item_to_tran' data-barcode='${item['barcode']}' data-name='${item['name']}'><i class='fa fa-download'></i></a></td>
                                                    </tr>`
                                        })

                                        $('#mat_bd').html(tr)
                                        $('.add_item_to_tran').click(function(){
                                            let barcode = $(this).data('barcode');
                                            let name = $(this).data('name');
                                            let sn = $('#tran_table tr').length + 1
                                            let row = `
                                                <tr id='row_${sn}'>
                                                    <td>${sn}</td>
                                                    <td id='barcode_${sn}'>${barcode}</td>
                                                    <td>${name}</td>
                                                    <td><input type="text" id="pack_${sn}" style="width: 100px !important" class="form-control form-control-sm rounded-0"></td>
                                                    <td><input type="text" id="pack_qty_${sn}" style="width: 100px !important" class="form-control form-control-sm rounded-0"></td>
                                                    <td><input type="text" id="sent_qty_${sn}" style="width: 100px !important" class="form-control form-control-sm rounded-0"></td>
                                                    <td><input type="text" id="rec_qty_${sn}" style="width: 100px !important" class="form-control form-control-sm rounded-0"></td>
                                                    <td><input type="text" id="total_cost_${sn}" style="width: 100px !important" class="form-control form-control-sm rounded-0"></td>
                                                </tr>
                                            `

                                            $('#tran_table').append(row)

                                        })
                                    } else {
                                        kasa.response(response)
                                    }
                                }).catch(error => {kasa.error(error)})
                            }
                        }
                    }
                })

            })
        })
    </script>
{% endblock %}